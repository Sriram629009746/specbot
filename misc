 for group in variable_groups:
        with st.sidebar.expander(f"Select Variables for {group['subplot_title']}"):
            select_all_key = f"select_all_{group['subplot_title']}"
            current_selections = {var['name']: st.session_state.get(f"{group['subplot_title']}_{var['name']}", var.get("default_enable", "no") == "yes") for var in group['variable_group']}
            select_all = st.checkbox(f"Select All for {group['subplot_title']}", value=all(current_selections.values()), key=select_all_key)
            
            for var in group['variable_group']:
                var_key = f"{group['subplot_title']}_{var['name']}"
                selections.setdefault(group['subplot_title'], {})[var['name']] = st.checkbox(var['name'], value=current_selections[var['name']], key=var_key)
            
            if select_all:
                for var in group['variable_group']:
                    st.session_state[f"{group['subplot_title']}_{var['name']}"] = True
            else:
                for var in group['variable_group']:
                    st.session_state[f"{group['subplot_title']}_{var['name']}"] = selections[group['subplot_title']][var['name']]
    
    if st.sidebar.button("Submit") or not any(selections.values()):
        for group in variable_groups:
            selected_vars = [var['name'] for var in group['variable_group'] if st.session_state.get(f"{group['subplot_title']}_{var['name']}", False)]
            if selected_vars:
                selected_group = group.copy()
                selected_group['variable_group'] = selected_vars
                selected_groups.append(selected_group)
        
        if selected_groups:
            plotter = DataPlotter(df, age_column, selected_groups)
            plotter.plot()
        else:
            st.warning("Please select at least one variable to display.")
